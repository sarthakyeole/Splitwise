{% extends "base.html" %}
{% block title %}{{ group.name }}{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>{{ group.name }}</h2>
  <div class="d-flex gap-2">
    <a href="{% url 'export_group_pdf' group.id %}" class="btn btn-outline-danger btn-sm ms-2">
      ‚¨á Export PDF
    </a>
    <a href="{% url 'export_group_csv' group.id %}" class="btn btn-outline-primary btn-sm">
      ‚¨á Export CSV
    </a>
    <a href="{% url 'activity_log' group.id %}" class="btn btn-outline-secondary btn-sm">
      üìú Activity Log
    </a>
  </div>
</div>

<!-- GROUP MEMBERS -->
<div class="card mb-4">
  <div class="card-header fw-bold">
    Group Members ({{ group.members.count }})
  </div>

  <ul class="list-group list-group-flush">
    {% for member in group.members.all %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        {{ member.username }}

        {% if member == user %}
          <span class="badge bg-primary">You</span>
        {% endif %}
      </li>
    {% endfor %}
  </ul>
</div>

<!-- RECENT ACTIVITY -->
<div class="card mb-4">
  <div class="card-header fw-bold">Recent Activity</div>
  <ul class="list-group list-group-flush">
    {% if recent_activities %}
      {% for activity in recent_activities %}
        <li class="list-group-item">
          {{ activity.message }}
          <div class="small text-muted">
            {{ activity.created_at|timesince }} ago
          </div>
        </li>
      {% endfor %}
    {% else %}
      <li class="list-group-item text-muted">No recent activity</li>
    {% endif %}
  </ul>
</div>

<!-- WHO OWES WHOM -->
<div class="card mb-4">
  <div class="card-header fw-bold">Who Should Pay Whom</div>
  <div class="card-body">
    {% if transactions %}
      {% for debtor, creditor, amount in transactions %}
        <form method="post"
              action="{% url 'quick_settle' group.id %}"
              class="row g-2 align-items-center mb-2">
          {% csrf_token %}
          <input type="hidden" name="paid_by" value="{{ debtor.id }}">
          <input type="hidden" name="paid_to" value="{{ creditor.id }}">

          <div class="col-md-5">
            <strong>{{ debtor.username }}</strong> ‚Üí {{ creditor.username }}
          </div>

          <div class="col-md-3">
            <input type="number"
                   name="amount"
                   class="form-control form-control-sm"
                   step="0.01"
                   min="0.01"
                   max="{{ amount }}"
                   value="{{ amount }}">
          </div>

          <div class="col-md-2">
            <button class="btn btn-success btn-sm w-100">
              Settle
            </button>
          </div>
        </form>
      {% endfor %}
    {% else %}
      <p class="text-muted mb-0">All settled üéâ</p>
    {% endif %}
  </div>
</div>

<!-- BALANCES -->
<div class="card mb-4">
  <div class="card-header fw-bold">Balances</div>
  <ul class="list-group list-group-flush">
    {% for user, amount in balance_entries %}
      <li class="list-group-item d-flex justify-content-between">
        {{ user.username }}
        <span class="{% if amount >= 0 %}text-success{% else %}text-danger{% endif %}">
          ‚Çπ{{ amount }}
        </span>
      </li>
    {% endfor %}
  </ul>
</div>

<!-- EXPENSES -->
<div class="card mb-4">
  <div class="card-header fw-bold d-flex justify-content-between align-items-center">
    Expenses
    <a href="{% url 'add_expense' group.id %}" class="btn btn-primary btn-sm">
      + Add Expense
    </a>
  </div>

  <ul class="list-group list-group-flush">
    {% for expense in expenses %}
      <li class="list-group-item">
        <strong>{{ expense.description }}</strong>
        <div class="small text-muted">
          Paid by {{ expense.paid_by.username }} ‚Äî ‚Çπ{{ expense.amount }}
        </div>

        <div class="mt-2">
          <span class="fw-semibold">Splits:</span>
          <ul class="mb-0">
            {% for split in expense.splits.all %}
              <li>{{ split.user.username }} : ‚Çπ{{ split.amount }}</li>
            {% endfor %}
          </ul>
        </div>
      </li>
    {% empty %}
      <li class="list-group-item text-muted">No expenses yet</li>
    {% endfor %}
  </ul>
</div>

<div class="d-flex gap-3">
  <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary btn-sm">
    ‚Üê Back to Groups
  </a>
</div>

{% endblock %}
